var NAILS_CDN_Manager;NAILS_CDN_Manager=function(){this.handler="",this.callback="",this.url_schemes={},this.is_fancybox="",this.reopen_fancybox="",this.init=function(t,i,e,n,a){this.handler=t,this.callback=i,this.url_schemes=e,this.is_fancybox=n,this.reopen_fancybox=a,this._init_submit(),this._init_alerts(),this._init_upload(),this._init_delete(),this._init_insert(),this._init_sidebar(),this._init_thumbs(),this._init_search();var o=!1;o="ckeditor"===this.handler?!0:this.is_fancybox?"function"==typeof parent[this.callback]?!0:!1:window.opener?"function"==typeof window.opener[this.callback]?!0:!1:!1,o||$("a.insert").remove(),$("a.cdn-fancybox").fancybox({padding:0,wrapCSS:"cdn-fancybox",helpers:{title:{type:"over"}}})},this._init_submit=function(){var t=this;$("form").on("submit",function(){t._show_mask()})},this._init_alerts=function(){var t=this;$(".system-alert .awesome").on("click",function(){return t._hide_alert(),!1}),$(document).on("keydown",function(t){13===t.keyCode&&$("#alert:visible").length>0&&$("#alert .awesome.ok").first().click(),27===t.keyCode&&$("#alert:visible").length>0&&$("#alert .awesome.cancel").first().click()})},this._init_upload=function(){},this._init_delete=function(){$("a.delete").on("click",function(){var t=$(this);return $("<div>").html("<p>Any resources which are using this object will have the reference removed.</p><p>Continue?</p>").dialog({title:"Are you sure?",resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{Delete:function(){window.location.href=t.attr("href")},Cancel:function(){$(this).dialog("close")}}}),!1})},this._init_insert=function(){var t=this;$("a.insert").on("click",function(){var i=$(this).attr("data-bucket"),e=$(this).attr("data-file"),n=$(this).attr("data-id");return"ckeditor"===t.handler?t._insert_ckeditor(i,e,n):t._insert_native(i,e,n),t.is_fancybox?parent.$.fancybox.close():window.close(),!1})},this._insert_ckeditor=function(t,i,e){var n=this.url_schemes.serve,a=i.split("."),o={bucket:t,filename:a[0],extension:"."+a[1],id:e,width:0,height:0,sex:"",border:0},s=Mustache.render(n,o);window.opener.CKEDITOR.tools.callFunction(this.callback,s)},this._insert_native=function(t,i,e){this.is_fancybox?parent[this.callback].call(t,i,e,this.reopen_fancybox):window.opener[this.callback].call(t,i,e,this.reopen_fancybox)},this._init_sidebar=function(){var t=this;$("li.tag.droppable").droppable({accept:".file",hoverClass:"can-drop",tolerance:"pointer",drop:function(i,e){var n=$(e.draggable).data("id"),a=$(this).data("id"),o=$(this),s=$(e.draggable);_api.call({controller:"cdnapi",method:"add_object_tag",action:"GET",data:{object_id:n,tag_id:a},success:function(i){t._add_tag_ok(o,s,i)},error:function(i){t._add_tag_fail(o,s,i)}}),$(this).find(".count").addClass("saving")}}),$("div.remove-object-tag").droppable({accept:".file",hoverClass:"can-drop",tolerance:"pointer",drop:function(i,e){var n=$(e.draggable).data("id"),a=$(this).data("id"),o=$(this),s=$(e.draggable);_api.call({controller:"cdnapi",method:"delete_object_tag",action:"GET",data:{object_id:n,tag_id:a},success:function(i){t._remove_tag_ok(o,s,i)},error:function(i){t._remove_tag_fail(o,s,i)}}),$(this).find(".count").addClass("saving")}})},this._add_tag_ok=function(t,i,e){t.find(".count").text(e.new_total).removeClass("saving")},this._add_tag_fail=function(t,i,e){var n;try{n=JSON.parse(e.responseText)}catch(a){n={error:"An unknown error occurred"}}alert(n.error),t.find(".count").removeClass("saving")},this._remove_tag_ok=function(t,i,e){i.remove(),t.removeClass("saving"),$("li.tag.selected .count").text(e.new_total)},this._remove_tag_fail=function(t,i,e){var n;try{n=JSON.parse(e.responseText)}catch(a){n={error:"An unknown error occurred"}}alert(n.error),t.removeClass("saving")},this._init_thumbs=function(){$(".file").draggable({helper:"clone",start:function(t,i){$(i.helper).addClass("clone")}})},this._init_search=function(){var t=this;$("#search-text").on("keyup",function(){return t._do_search($(this).val()),!1})},this._do_search=function(t){$("li.file,tr.file:not(.head)").each(function(){var i=new RegExp(t,"gi");i.test($(this).attr("data-title"))?$(this).show():$(this).hide()})},this._show_mask=function(){$("#mask").show()},this._hide_mask=function(){$("#mask").hide()},this._show_alert=function(){$("#alert").show()},this._hide_alert=function(){$("#alert").hide()}};